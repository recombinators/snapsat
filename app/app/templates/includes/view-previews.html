<script type='text/javascript' src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<div class='preview-container clearfix px5 mt4 mb4 bg-black'>

    {% for band_combo, composite in composites.iteritems() %}

    <div class='js-preview sm-col sm-col-6 md-col md-col-4 lg-col lg-col-3 relative' id='{{ band_combo }}'>

        <!-- Scene composite metadata -->
        <div class='scene-meta white full-width'>

            <!-- Full render download button -->
            {% if composite.fullurl %}
                <a  class='button not-rounded full-width center' 
                    href="{{ composite.fullurl }}">Download full size image.
                </a>

            <!-- If a full render has NOT been created, display a means of creating one. -->
            {% else %}
                <div class='js-nofull' id='{{composite.fulljobid}}'>
                    <!-- TODO: This is currently handled poorly. -->
                    <!-- If a full has been requested, display the processing status. -->
                    {% if composite.fullstatus %}
                        <a  class='button not-rounded full-width center' id='js-fullstatus'>{{ composite.fullstatus }}</a>
                    {% else %}
                        <button id="js-opener{{band_combo}}" class='button not-rounded left full-width center'>
                            Request a full size image.</button>
                        <div id="js-dialog{{band_combo}}" class='js-modal' title="Email notification">
                            <form method='post'>
                                <input class='mb1 left full-width center' type="email" name="email_address" placeholder="Email (optional)"/>
                                <input type="hidden" name='band1' value="{{ composite.band1 }}"/>
                                <input type="hidden" name='band2' value="{{ composite.band2 }}"/>
                                <input type="hidden" name='band3' value="{{ composite.band3 }}"/>
                                <p class='px1 center'>A full render is ready in ~3 minutes, but high traffic volumes can lead to a longer wait.</p>
                                <p class='px1 center'>Enter your email address for notification.</p>
                                <button
                                    class='button not-rounded left full-width center'
                                    formaction="/request_composite/{{ meta_data.scene_id }}"
                                    formmethod="post"
                                    type="submit">Request a full size image.
                                </button>
                            </form>
                        </div>
                        <script>
                            // modal code
                            $( "#js-dialog{{band_combo}}" ).dialog({
                                autoOpen: false,
                                modal: true
                            });
                            $( "#js-opener{{band_combo}}" ).click(function() {
                                // prevent scrolling
                                $("html,body").css("overflow","hidden");
                                $( "#js-dialog{{band_combo}}" ).dialog( "open" );
                            });
                            // on modal close, allow scrolling.
                            $( "#js-dialog{{band_combo}}" ).dialog({
                                close: function() {
                                    $("html,body").css("overflow","auto");
                                }
                            });
                        </script>
                    {% endif %}
                </div> <!-- nofull -->
            {% endif %}
        </div> <!-- scene-meta -->

        <div class='preview-block'>
            <!-- Scene barcode visualization -->
            <div class='js-graph' id='graph{{composite.previewjobid}}'></div>
            
            <!-- Display the band combination of the composite -->
            <h1 class='composite-description'>
                    <span class='band-red red'>{{ composite.band1 }}</span> <span class='band-green green'>{{ composite.band2 }}</span> 
                    <span class='band-blue blue'>{{ composite.band3 }}</span>
            </h1>
        </div>

        <!-- Display preview or loading gif -->
        <div id='{{composite.previewjobid}}'>
            {% if composite.previewurl %}
                <a href="{{ composite.previewurl }}">
                    <img src="{{ composite.previewurl }}">
                </a>
            {% else %}
            <div class='js-nopreview' id='{{composite.previewjobid}}'>
                <img class='loading' src="/static/img/loading.gif">
            </div>
            {% endif %}
        </div>
    </div> <!-- preview -->
    {% endfor %}
</div> <!-- preview-container -->

<style>
div.modal-bg {
  background:#000;
  position:fixed;
  top:0; left:0;
  width:100%;
  height:100%;
  z-index:10;
}
</style>